<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="generator" content="bookdown 0.6 and GitBook 2.6.7">

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="module-outline.html">
<link rel="next" href="tidy-data.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Index file</a></li>
<li class="chapter" data-level="2" data-path="module-outline.html"><a href="module-outline.html"><i class="fa fa-check"></i><b>2</b> Module outline</a><ul>
<li class="chapter" data-level="2.1" data-path="module-outline.html"><a href="module-outline.html#practical-arrangements"><i class="fa fa-check"></i><b>2.1</b> Practical arrangements</a></li>
<li class="chapter" data-level="2.2" data-path="module-outline.html"><a href="module-outline.html#aims-of-the-module"><i class="fa fa-check"></i><b>2.2</b> Aims of the module</a></li>
<li class="chapter" data-level="2.3" data-path="module-outline.html"><a href="module-outline.html#attendance"><i class="fa fa-check"></i><b>2.3</b> Attendance</a></li>
<li class="chapter" data-level="2.4" data-path="module-outline.html"><a href="module-outline.html#assessment"><i class="fa fa-check"></i><b>2.4</b> Assessment</a></li>
<li class="chapter" data-level="2.5" data-path="module-outline.html"><a href="module-outline.html#syllabus-plan"><i class="fa fa-check"></i><b>2.5</b> Syllabus plan</a></li>
<li class="chapter" data-level="2.6" data-path="module-outline.html"><a href="module-outline.html#reading-list"><i class="fa fa-check"></i><b>2.6</b> Reading list</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="joining.html"><a href="joining.html"><i class="fa fa-check"></i><b>3</b> Joining data from the Understanding Society</a><ul>
<li class="chapter" data-level="3.1" data-path="joining.html"><a href="joining.html#joining-waves-1-and-2"><i class="fa fa-check"></i><b>3.1</b> Joining waves 1 and 2</a></li>
<li class="chapter" data-level="3.2" data-path="joining.html"><a href="joining.html#joining-waves-1-to-7"><i class="fa fa-check"></i><b>3.2</b> Joining waves 1 to 7</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tidy-data.html"><a href="tidy-data.html"><i class="fa fa-check"></i><b>4</b> Tidy data</a><ul>
<li class="chapter" data-level="4.1" data-path="tidy-data.html"><a href="tidy-data.html#long-and-wide-formats"><i class="fa fa-check"></i><b>4.1</b> Long and wide formats</a></li>
<li class="chapter" data-level="4.2" data-path="tidy-data.html"><a href="tidy-data.html#cleaning-the-data"><i class="fa fa-check"></i><b>4.2</b> Cleaning the data</a></li>
<li class="chapter" data-level="4.3" data-path="tidy-data.html"><a href="tidy-data.html#homework"><i class="fa fa-check"></i><b>4.3</b> Homework</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="joining" class="section level1">
<h1><span class="header-section-number">3</span> Joining data from the Understanding Society</h1>
<p>At home you read ch.13 on Relational Data from R for Data Science – <a href="http://r4ds.had.co.nz/relational-data.html" class="uri">http://r4ds.had.co.nz/relational-data.html</a>. Let us see how we can apply this to the Understanding Society data.</p>
<div id="joining-waves-1-and-2" class="section level2">
<h2><span class="header-section-number">3.1</span> Joining waves 1 and 2</h2>
<p>I will start with joining data from waves 1 and 2 and then expand the algorithm to all the seven waves. First we need to read the data into R.</p>
<p>I am using the fundtion <strong>read_tsv()</strong> from the <strong>readr</strong> package here since the data are tab separated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First I attach the packages I will use later. You need to install these packages first.</span>
<span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(reshape2)

UndSoc1 &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(<span class="st">&quot;data/UKDA-6614-tab/tab/us_w1/a_indresp.tab&quot;</span>)</code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_integer(),
##   a_jbhrs = col_double(),
##   a_extrate = col_double(),
##   a_basrate = col_double(),
##   a_ovtrate = col_double(),
##   a_sf12pcs_dv = col_double(),
##   a_sf12mcs_dv = col_double(),
##   a_bmi_dv = col_double(),
##   a_payg_dv = col_double(),
##   a_payn_dv = col_double(),
##   a_payu_dv = col_double(),
##   a_paygu_dv = col_double(),
##   a_paynu_dv = col_double(),
##   a_seearngrs_dv = col_double(),
##   a_seearnnet_dv = col_double(),
##   a_j2pay_dv = col_double(),
##   a_fiyrinvinc_dv = col_double(),
##   a_fibenothr_dv = col_double(),
##   a_fibenothr_if = col_double(),
##   a_fimnlabgrs_dv = col_double(),
##   a_fimnlabgrs_if = col_double()
##   # ... with 16 more columns
## )</code></pre>
<pre><code>## See spec(...) for full column specifications.</code></pre>
<pre><code>## Warning in rbind(names(probs), probs_f): number of columns of result is not
## a multiple of vector length (arg 1)</code></pre>
<pre><code>## Warning: 13 parsing failures.
## row # A tibble: 5 x 5 col     row          col   expected           actual expected   &lt;int&gt;        &lt;chr&gt;      &lt;chr&gt;            &lt;chr&gt; actual 1  1197 a_lenindintv an integer .550000011920929 file 2  1199 a_lenindintv an integer .200000002980232 row 3  1200 a_lenindintv an integer .400000005960464 col 4  4665 a_lenindintv an integer               .5 expected 5  5652 a_lenindintv an integer .449999988079071 actual # ... with 1 more variables: file &lt;chr&gt;
## ... ................. ... ................................................ ........ ................................................ ...... ................................................ .... ................................................ ... ................................................ ... ................................................ ........ ................................................ ...... .......................................
## See problems(...) for more details.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">UndSoc2 &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(<span class="st">&quot;data/UKDA-6614-tab/tab/us_w2/b_indresp.tab&quot;</span>)</code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   .default = col_integer(),
##   b_jbhrs = col_double(),
##   b_extrate = col_double(),
##   b_basrate = col_double(),
##   b_ovtrate = col_double(),
##   b_penmpy = col_double(),
##   b_scnalcpint = col_double(),
##   b_scnalcshot = col_double(),
##   b_scnalcwine = col_double(),
##   b_sf12pcs_dv = col_double(),
##   b_sf12mcs_dv = col_double(),
##   b_payg_dv = col_double(),
##   b_payn_dv = col_double(),
##   b_payu_dv = col_double(),
##   b_paygu_dv = col_double(),
##   b_paynu_dv = col_double(),
##   b_seearngrs_dv = col_double(),
##   b_seearnnet_dv = col_double(),
##   b_j2pay_dv = col_double(),
##   b_fiyrinvinc_dv = col_double(),
##   b_fibenothr_dv = col_double()
##   # ... with 25 more columns
## )
## See spec(...) for full column specifications.</code></pre>
<pre><code>## Warning in rbind(names(probs), probs_f): number of columns of result is not
## a multiple of vector length (arg 1)</code></pre>
<pre><code>## Warning: 43931 parsing failures.
## row # A tibble: 5 x 5 col     row          col               expected          actual expected   &lt;int&gt;        &lt;chr&gt;                  &lt;chr&gt;           &lt;chr&gt; actual 1  1575 b_indin91_lw no trailing characters .15808284282684 file 2  1575 b_indin01_lw no trailing characters .09862232208252 row 3  1575 b_indpxbh_xw no trailing characters .09886026382446 col 4  1575 b_indinbh_xw no trailing characters .05166864395142 expected 5  1575 b_indscbh_xw no trailing characters .14312696456909 actual # ... with 1 more variables: file &lt;chr&gt;
## ... ................. ... ........................................................... ........ ........................................................... ...... ........................................................... .... ........................................................... ... ........................................................... ... ........................................................... ........ ........................................................... ...... .......................................
## See problems(...) for more details.</code></pre>
<p>These are very large files that take a lot of space in the memory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">format</span>(<span class="kw">object.size</span>(UndSoc1), <span class="dt">units =</span> <span class="st">&quot;auto&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;273 Mb&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">format</span>(<span class="kw">object.size</span>(UndSoc2), <span class="dt">units =</span> <span class="st">&quot;auto&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;350.6 Mb&quot;</code></pre>
<p>Before joining these two data frames I may want to select only the variables I need. These are:</p>
<ul>
<li><p><strong>pidp</strong>: this is the unique cross-wave individual number (in both waves),</p></li>
<li><p><strong>a_sex</strong>: sex from wave 1,</p></li>
<li><p><strong>a_dvage</strong>: age from wave 1,</p></li>
<li><p><strong>a_vote6</strong>: level of interest in politics from wave 1,</p></li>
<li><p><strong>b_sex</strong>: sex from wave 2,</p></li>
<li><p><strong>b_dvage</strong>: age from wave 2,</p></li>
<li><p><strong>b_vote6</strong>: level of interest in politics from wave 2.</p></li>
</ul>
<p>Note that for now I keep it intentionally simple.</p>
<p>First I will edit both data sets to keep only the variables I need.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">UndSoc1ed &lt;-<span class="st"> </span>UndSoc1 <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(pidp, a_sex, a_dvage, a_vote6)
UndSoc2ed &lt;-<span class="st"> </span>UndSoc2 <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(pidp, b_sex, b_dvage, b_vote6)</code></pre></div>
<p>Note that these are much smaller objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">format</span>(<span class="kw">object.size</span>(UndSoc1ed), <span class="dt">units =</span> <span class="st">&quot;auto&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;1.3 Mb&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">format</span>(<span class="kw">object.size</span>(UndSoc2ed), <span class="dt">units =</span> <span class="st">&quot;auto&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;5.5 Mb&quot;</code></pre>
<p>I will remove the larger data sets from the memory to free it up.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(UndSoc1, UndSoc2)</code></pre></div>
<p>Let us explore the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(UndSoc1ed)</code></pre></div>
<pre><code>## # A tibble: 6 x 4
##       pidp a_sex a_dvage a_vote6
##      &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
## 1 68001367     1      39       3
## 2 68004087     1      59       2
## 3 68006127     2      39       4
## 4 68006135     2      17       4
## 5 68006807     2      72       4
## 6 68007487     2      57       1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(UndSoc2ed)</code></pre></div>
<pre><code>## # A tibble: 6 x 4
##       pidp b_sex b_dvage b_vote6
##      &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
## 1 68004087     1      60       2
## 2 68006127     2      40       4
## 3 68006807     2      73       4
## 4 68007487     2      58       2
## 5 68008167     2      39       4
## 6 68008171     1      52      -7</code></pre>
<p>Now we can join the data sets. As you know already, there can be several types of joins. Inner join will keep the observations that match in both data frames.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inner &lt;-<span class="st"> </span>UndSoc1ed <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">inner_join</span>(UndSoc2ed, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)</code></pre></div>
<p>Note that I use the variable <strong>pidp</strong> as the key for joining.</p>
<p>The same result can be achieved with the function <strong>merge</strong> from base R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inner2 &lt;-<span class="st"> </span>UndSoc1ed <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">merge</span>(UndSoc2ed, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)
<span class="kw">identical</span>(<span class="kw">as.data.frame</span>(inner), inner2)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>These two data frames are identical. Note the use of <strong>as.data.frame()</strong>. <strong>inner</strong> is a tibble and unless converted into a simple data frame it is not identical to <strong>inner2</strong> because of the differences in object type.</p>
<p>Inner join will only retain individuals that are present in both waves. This is why we only have 38388 observations in the joined data compared to 50994 in wave 1. But do we want this? Imagine that the person is present in wave 1, does not participate in wave 2, but then re-appears in wave 3. We probably want to include such individuals as well.</p>
<p>Left join will keep all individuals in wave 1 and only those in wave 2 that can be matched to them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">left &lt;-<span class="st"> </span>UndSoc1ed <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">left_join</span>(UndSoc2ed, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)
<span class="co"># or, identically,</span>
<span class="co"># left &lt;- UndSoc1ed %&gt;%</span>
<span class="co">#         merge(UndSoc2ed, by = &quot;pidp&quot;, all.x = TRUE)</span></code></pre></div>
<p>You can check that the number of individuals in wave 1 and the joined data frame is the same.</p>
<p>Right join will keep all individuals from wave 2 and only those from wave 1 that can be matched to them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">right &lt;-<span class="st"> </span>UndSoc1ed <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">right_join</span>(UndSoc2ed, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)
<span class="co"># or, identically,</span>
<span class="co"># right &lt;- UndSoc1ed %&gt;%</span>
<span class="co">#         merge(UndSoc2ed, by = &quot;pidp&quot;, all.y = TRUE)</span></code></pre></div>
<p>Usually I would want all the individuals from both waves to remain in the data set, no matter if they can be matched to other waves. If I need to exclude them from the analysis I prefer to do this manually. This can be achieved with full join.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">full &lt;-<span class="st"> </span>UndSoc1ed <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">full_join</span>(UndSoc2ed, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)
<span class="co"># or, identically,</span>
<span class="co"># full &lt;- UndSoc1ed %&gt;%</span>
<span class="co">#          merge(UndSoc2ed, by = &quot;pidp&quot;, all = TRUE)</span></code></pre></div>
<p>Note that <strong>full</strong> has 67203 observations compared to 50994 in wave 1 and 54597 in wave 2. This is because it includes a) all individuals that took part in both waves 1 and 2, b) those who took part in wave 1, but not in wave 2, c) those who missed wave 1 but joined the study in wave 2.</p>
<p>Let us explore the joined data set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(full)</code></pre></div>
<pre><code>## # A tibble: 6 x 7
##       pidp a_sex a_dvage a_vote6 b_sex b_dvage b_vote6
##      &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
## 1 68001367     1      39       3    NA      NA      NA
## 2 68004087     1      59       2     1      60       2
## 3 68006127     2      39       4     2      40       4
## 4 68006135     2      17       4    NA      NA      NA
## 5 68006807     2      72       4     2      73       4
## 6 68007487     2      57       1     2      58       2</code></pre>
<p>We have missing values for wave 1 variable for those people who joined in wave 2.</p>
</div>
<div id="joining-waves-1-to-7" class="section level2">
<h2><span class="header-section-number">3.2</span> Joining waves 1 to 7</h2>
<p>Now let us join data from all seven waves. The challenge here is that we do not want to do every operation seven times so we may want to use some iterative tools that we learned last week.</p>
<p>Note that the variables across the waves are named consistently, and the difference between the variables from different waves is the prefix that changes from “a” in wave 1 to “g” in wave 7.</p>
<p>We may want to write a loop that reads a file for a particular wave into R, selects only the variables we need, joins the data, removes the original file from the memory and proceeds to the next wave.</p>
<p>First let us clean the space and remove all the existing objects from the memory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())</code></pre></div>
<p>Now we will create a character vector with the full paths to the individual indresp files from all the waves.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">files &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="st">&quot;data/UKDA-6614-tab/tab&quot;</span>,
             <span class="dt">pattern=</span><span class="st">&quot;indresp&quot;</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>)
files</code></pre></div>
<pre><code>##  [1] &quot;data/UKDA-6614-tab/tab/bhps_w1/ba_indresp.tab&quot; 
##  [2] &quot;data/UKDA-6614-tab/tab/bhps_w10/bj_indresp.tab&quot;
##  [3] &quot;data/UKDA-6614-tab/tab/bhps_w11/bk_indresp.tab&quot;
##  [4] &quot;data/UKDA-6614-tab/tab/bhps_w12/bl_indresp.tab&quot;
##  [5] &quot;data/UKDA-6614-tab/tab/bhps_w13/bm_indresp.tab&quot;
##  [6] &quot;data/UKDA-6614-tab/tab/bhps_w14/bn_indresp.tab&quot;
##  [7] &quot;data/UKDA-6614-tab/tab/bhps_w15/bo_indresp.tab&quot;
##  [8] &quot;data/UKDA-6614-tab/tab/bhps_w16/bp_indresp.tab&quot;
##  [9] &quot;data/UKDA-6614-tab/tab/bhps_w17/bq_indresp.tab&quot;
## [10] &quot;data/UKDA-6614-tab/tab/bhps_w18/br_indresp.tab&quot;
## [11] &quot;data/UKDA-6614-tab/tab/bhps_w2/bb_indresp.tab&quot; 
## [12] &quot;data/UKDA-6614-tab/tab/bhps_w3/bc_indresp.tab&quot; 
## [13] &quot;data/UKDA-6614-tab/tab/bhps_w4/bd_indresp.tab&quot; 
## [14] &quot;data/UKDA-6614-tab/tab/bhps_w5/be_indresp.tab&quot; 
## [15] &quot;data/UKDA-6614-tab/tab/bhps_w6/bf_indresp.tab&quot; 
## [16] &quot;data/UKDA-6614-tab/tab/bhps_w7/bg_indresp.tab&quot; 
## [17] &quot;data/UKDA-6614-tab/tab/bhps_w8/bh_indresp.tab&quot; 
## [18] &quot;data/UKDA-6614-tab/tab/bhps_w9/bi_indresp.tab&quot; 
## [19] &quot;data/UKDA-6614-tab/tab/us_w1/a_indresp.tab&quot;    
## [20] &quot;data/UKDA-6614-tab/tab/us_w2/b_indresp.tab&quot;    
## [21] &quot;data/UKDA-6614-tab/tab/us_w3/c_indresp.tab&quot;    
## [22] &quot;data/UKDA-6614-tab/tab/us_w4/d_indresp.tab&quot;    
## [23] &quot;data/UKDA-6614-tab/tab/us_w5/e_indresp.tab&quot;    
## [24] &quot;data/UKDA-6614-tab/tab/us_w6/f_indresp.tab&quot;    
## [25] &quot;data/UKDA-6614-tab/tab/us_w7/g_indresp.tab&quot;</code></pre>
<p>This includes files from the BHPS that we don’t need so let us drop them. We can use the function <strong>str_detect()</strong> (part of the stringr package) to identify files from the Understanding Society only and then keep only their names in the vector <strong>files</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_detect</span>(files, <span class="st">&quot;us&quot;</span>)</code></pre></div>
<pre><code>##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE
## [23]  TRUE  TRUE  TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">files &lt;-<span class="st"> </span>files[<span class="kw">str_detect</span>(files, <span class="st">&quot;us&quot;</span>)]
files</code></pre></div>
<pre><code>## [1] &quot;data/UKDA-6614-tab/tab/us_w1/a_indresp.tab&quot;
## [2] &quot;data/UKDA-6614-tab/tab/us_w2/b_indresp.tab&quot;
## [3] &quot;data/UKDA-6614-tab/tab/us_w3/c_indresp.tab&quot;
## [4] &quot;data/UKDA-6614-tab/tab/us_w4/d_indresp.tab&quot;
## [5] &quot;data/UKDA-6614-tab/tab/us_w5/e_indresp.tab&quot;
## [6] &quot;data/UKDA-6614-tab/tab/us_w6/f_indresp.tab&quot;
## [7] &quot;data/UKDA-6614-tab/tab/us_w7/g_indresp.tab&quot;</code></pre>
<p>Now let us write the loop.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># These are the variables we want to select from each wave without prefixes</span>
<span class="co"># (exclusing pidp).</span>
vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;dvage&quot;</span>, <span class="st">&quot;vote6&quot;</span>)

<span class="co"># We will loop over numbers from 1 to 7</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">7</span>) {
        <span class="co"># Create a vector of the variables to select. I need to add the prefix.</span>
        <span class="co"># Note the use of the function letters()</span>
        varsToSelect &lt;-<span class="st"> </span><span class="kw">paste</span>(letters[i], vars, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
        <span class="co"># Add pidp (no prefix for pidp)</span>
        varsToSelect &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pidp&quot;</span>, varsToSelect)
        
        <span class="co"># Now read the data. I only need to read the select variables.</span>
        <span class="co"># I will use the fread() function from the data.table package</span>
        <span class="co"># (it&#39;s faster and it&#39;s easier to select only some variables)</span>
        data &lt;-<span class="st"> </span><span class="kw">fread</span>(files[i], <span class="dt">select =</span> varsToSelect)
        
        <span class="co"># Now, if this is the first iteration of the loop we simply want to initialise</span>
        <span class="co"># the data frame with these data.</span>
        <span class="co"># If this is not the first iteration of the loop</span>
        <span class="co"># we need to use full_join.</span>
        <span class="co"># To achieve this result we will use the conditional operator if... else</span>
        <span class="cf">if</span> (i <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {
                all7 &lt;-<span class="st"> </span>data  
        }
        <span class="cf">else</span> {
                all7 &lt;-<span class="st"> </span><span class="kw">full_join</span>(all7, data, <span class="dt">by =</span> <span class="st">&quot;pidp&quot;</span>)
        }
        <span class="co"># Now we can remove the full data frame</span>
        <span class="kw">rm</span>(data)
}

<span class="co"># Check the result</span>
<span class="kw">colnames</span>(all7)</code></pre></div>
<pre><code>##  [1] &quot;pidp&quot;    &quot;a_sex&quot;   &quot;a_dvage&quot; &quot;a_vote6&quot; &quot;b_sex&quot;   &quot;b_dvage&quot; &quot;b_vote6&quot;
##  [8] &quot;c_sex&quot;   &quot;c_dvage&quot; &quot;c_vote6&quot; &quot;d_sex&quot;   &quot;d_dvage&quot; &quot;d_vote6&quot; &quot;e_sex&quot;  
## [15] &quot;e_dvage&quot; &quot;e_vote6&quot; &quot;f_sex&quot;   &quot;f_dvage&quot; &quot;f_vote6&quot; &quot;g_sex&quot;   &quot;g_dvage&quot;
## [22] &quot;g_vote6&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(all7)</code></pre></div>
<pre><code>##       pidp a_sex a_dvage a_vote6 b_sex b_dvage b_vote6 c_sex c_dvage
## 1 68001367     1      39       3    NA      NA      NA    NA      NA
## 2 68004087     1      59       2     1      60       2     1      61
## 3 68006127     2      39       4     2      40       4     2      41
## 4 68006135     2      17       4    NA      NA      NA     2      19
## 5 68006807     2      72       4     2      73       4     2      74
## 6 68007487     2      57       1     2      58       2     2      59
##   c_vote6 d_sex d_dvage d_vote6 e_sex e_dvage e_vote6 f_sex f_dvage
## 1      NA    NA      NA      NA    NA      NA      NA    NA      NA
## 2       2     1      62       1     1      63       2     1      64
## 3       4     2      43       4     2      43       4     2      44
## 4       4     2      21       2     2      21       4    NA      NA
## 5       4     2      75       4     2      76       4     2      77
## 6       4     2      60       1    NA      NA      NA    NA      NA
##   f_vote6 g_sex g_dvage g_vote6
## 1      NA    NA      NA      NA
## 2       2     1      65       2
## 3       4     2      45       4
## 4      NA     2      23      -7
## 5       4     2      78       3
## 6      NA    NA      NA      NA</code></pre>
<p>Now I will save this joined data frame for the future use. I will write it into the myData folder. Make sure that this folder is NOT tracked on Github as a) the data file is too large for tracking, b) we cannot put data in public access.</p>
<p>To keep the folder untracked, just add the following line to your .gitignore file:</p>
<p>myData/</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># You need to create the myData folder first</span>

<span class="kw">write_tsv</span>(all7, <span class="st">&quot;myData/all7.tab&quot;</span>)</code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="module-outline.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tidy-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
